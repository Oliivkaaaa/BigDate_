CREATE TABLE ST.ALEX_SALARY_HIST (
  PERSON VARCHAR(255), 
  CLASS VARCHAR(255), 
  SALARY NUMERIC, 
  EFFECTIVE_FROM DATE, 
  EFFECTIVE_TO DATE
);
WITH interval_data AS (
  SELECT 
    PERSON, 
    CLASS, 
    SALARY, 
    DT AS EFFECTIVE_FROM, 
    LEAD(DT) OVER (
      PARTITION BY PERSON 
      ORDER BY DT
    ) AS NEXT_EFFECTIVE_FROM 
  FROM DE.HISTGROUP
)
INSERT INTO ST.ALEX_SALARY_HIST (
  PERSON, CLASS, SALARY, EFFECTIVE_FROM, EFFECTIVE_TO
) 
SELECT 
  PERSON, 
  CLASS, 
  SALARY, 
  EFFECTIVE_FROM, 
  COALESCE(
    NEXT_EFFECTIVE_FROM - INTERVAL '1 DAY', 
    DATE '2999-12-31'
  ) AS EFFECTIVE_TO 
FROM interval_data 
ORDER BY PERSON, EFFECTIVE_FROM;

CREATE TABLE ST.ALEX_SALARY_LOG(
  PAYMENT_DT TIMESTAMP, 
  PERSON VARCHAR(50), 
  PAYMENT INT, 
  MONTH_PAID INT, 
  MONTH_REST INT
);
INSERT INTO ST.ALEX_SALARY_LOG (
  PAYMENT_DT, PERSON, PAYMENT, MONTH_PAID, MONTH_REST
) 
SELECT 
  T1.DT AS PAYMENT_DT, 
  T1.PERSON, 
  T1.PAYMENT, 
  SUM(T1.PAYMENT) OVER (
    PARTITION BY T1.PERSON, DATE_TRUNC('MONTH', T1.DT) 
    ORDER BY T1.DT ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  ) AS MONTH_PAID, 
  T2.SALARY - SUM(T1.PAYMENT) OVER (
    PARTITION BY T1.PERSON, DATE_TRUNC('MONTH', T1.DT) 
    ORDER BY T1.DT ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
  ) AS MONTH_REST 
FROM 
  DE.SALARY_PAYMENTS AS T1 
  INNER JOIN ST.ALEX_SALARY_HIST AS T2 ON T1.PERSON = T2.PERSON 
  AND T1.DT BETWEEN T2.EFFECTIVE_FROM AND T2.EFFECTIVE_TO;